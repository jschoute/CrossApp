
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cross - Chronométrage par QR Code</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
    h1 { text-align: center; }
    #startTimeDisplay { font-size: 1.2em; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #eee; }
    #video { width: 100%; max-width: 600px; margin: 20px auto; display: block; }
    #startButton { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Chronométrage du Cross - Scanner QR Code</h1>
  <button id="startButton">Démarrer la course</button>
  <div id="startTimeDisplay">Heure de départ : -</div>
  <video id="video" autoplay muted playsinline></video>
  <table id="resultsTable">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Prénom</th>
        <th>Classe</th>
        <th>Équipe</th>
        <th>Dossard</th>
        <th>Temps</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script>
    let startTime = null;
    let video = document.getElementById("video");
    let startTimeDisplay = document.getElementById("startTimeDisplay");
    let resultTable = document.getElementById("resultsTable").getElementsByTagName("tbody")[0];

    document.getElementById("startButton").onclick = () => {
      startTime = new Date();
      startTimeDisplay.textContent = "Heure de départ : " + startTime.toLocaleTimeString();
    };

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
      video.srcObject = stream;
      let canvas = document.createElement("canvas");
      let context = canvas.getContext("2d");

      function scan() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          let code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
          if (code) {
            processQRCode(code.data);
          }
        }
        requestAnimationFrame(scan);
      }
      scan();
    });

    function processQRCode(data) {
      if (!startTime) {
        alert("Veuillez d'abord démarrer la course.");
        return;
      }

      let qrData;
      try {
        qrData = JSON.parse(data);
      } catch (e) {
        alert("QR Code invalide.");
        return;
      }

      let now = new Date();
      let diff = new Date(now - startTime);
      let minutes = String(diff.getUTCMinutes()).padStart(2, '0');
      let seconds = String(diff.getUTCSeconds()).padStart(2, '0');
      let millis = String(Math.floor(diff.getUTCMilliseconds() / 10)).padStart(2, '0');
      let raceTime = `${minutes}:${seconds}:${millis}`;

      let newRow = resultTable.insertRow();
      newRow.innerHTML = `
        <td>${qrData.nom}</td>
        <td>${qrData.prenom}</td>
        <td>${qrData.classe}</td>
        <td>${qrData.equipe}</td>
        <td>${qrData.numero}</td>
        <td>${raceTime}</td>
      `;

      // Envoi vers Google Sheets
      const sheetURL = "https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbx5Ni3LR9QbqLwIbabBYtUFaE-0SMCheYnG5oxcdNZ_gssy3rBoJYTJwPYmGHLo7WQF_w/exec";
      let payload = {
        nom: qrData.nom,
        prenom: qrData.prenom,
        classe: qrData.classe,
        equipe: qrData.equipe,
        numero: qrData.numero,
        temps: raceTime
      };

      fetch(sheetURL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    }
  </script>
</body>
</html>
